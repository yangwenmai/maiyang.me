---
layout: post
title: '负载均衡'
keywords: load balance
date: 2018-02-02 06:15:00
description: '本文是我对负载均衡的一些理解和总结。'
categories: [LB]
tags: [负载均衡, LB]
comments: true
author: mai
---

    本文是我对负载均衡的一些理解和总结。

----

负载平衡（Load balancing）是一种计算机网络技术，用来在多个计算机（计算机集群）、网络连接、CPU、磁盘驱动器或其他资源中分配负载，以达到最优化资源使用、最大化吞吐率、最小化响应时间、同时避免过载的目的。

实现方式：
- 服务器端负载均衡；
- 客户端负载均衡；

服务器端负载均衡分为硬件负载均衡及软件负载均衡。

硬件负载均衡，顾名思义，在服务器节点之间安装专门的硬件进行负载均衡的工作，F5便为其中的佼佼者。软件负载均衡则是通过在服务器上安装的特定的负载均衡软件或是自带负载均衡模块完成对请求的分配派发。

负载均衡器的任务：

- 服务发现：系统中有哪些后端可用？这些后端的地址（也就是：负载均衡器如何同这些后端通信）？
- 健康检查：哪些后端是健康的可以用于接收请求？
- 负载均衡：用什么算法来把独立的请求分发给健康的后端？

在分布式系统中合理的使用负载均衡能带来很多好处：

- 命名抽象：每个客户端不再需要知道每一个后端(服务发现)，客户端可以通过预定义的机制来找到负载均衡器，然后让负载均衡器完成命名解析功能。这些机制包括内置库，以及路人皆知的 DNS/IP/端口 地址，后面会深入讨论。
- 错误隔离：通过健康检查以及一些其他的算法和技术，负载均衡器的路由方法能够有效的绕过瘫痪或过载的后端。这样运维人员在面对系统故障时，就可以更加从容的进行错误处理。
- 成本和性能收益：分布式系统的网络的一致性比较差。系统通常要跨越多个网络区域。同一区域内，网络资源通常是低售的；而在跨区域的情况下，超售则是常态（超售和低售的鉴别，是通过网卡上可消耗的带宽和路由器之间的可用带宽进行比对得出的结论）。智能的负载均衡会尽可能保证通信在同一区域内进行，从而提高性能(降低延迟)并降低总体系统成本(降低区域间的带宽和光纤需求)。

健康检查有两种实现思路：

- 主动式：负载均衡器周期性的向后端发送 ping (例如一个发送到/healthcheck端点的 HTTP 请求)，以此判断后端的健康情况。
- 被动式：负载均衡器通过对主数据流的分析来确定健康情况。比如一个四层负载均衡器，在发现连续三个连接错误的情况下，就会判定一个后端不可用；七层负载均衡可能会在连续三个 HTTP 503 响应之后判定这一后端为不健康状态。

----

负载均衡常用算法

- 轮询法（Round Robin）
- 加权轮询法（Weight Robin）
- 随机法（Random）
- 加权随机法（Weight Random）
- 最小连接法（Least Connections）
- 最小响应时间
- 源地址哈希法（Hash）

rpc与http：

首先要否认一点 http 协议相较于自定义tcp报文协议，增加的开销在于连接的建立与断开。http协议是支持连接池复用的，也就是建立一定数量的连接不断开，并不会频繁的创建和销毁连接。二一要说的是http也可以使用protobuf这种二进制编码协议对内容进行编码，因此二者最大的区别还是在传输协议上。

RPC主要是基于TCP/IP协议的，而HTTP服务主要是基于HTTP协议的

OSI网络七层模型

在说RPC和HTTP的区别之前，我觉的有必要了解一下OSI的七层网络结构模型（虽然实际应用中基本上都是五层），它可以分为以下几层： （从上到下）

第一层：应用层。定义了用于在网络中进行通信和传输数据的接口；
第二层：表示层。定义不同的系统中数据的传输格式，编码和解码规范等；
第三层：会话层。管理用户的会话，控制用户间逻辑连接的建立和中断；
第四层：传输层。管理着网络中的端到端的数据传输；
第五层：网络层。定义网络设备间如何传输数据；
第六层：链路层。将上面的网络层的数据包封装成数据帧，便于物理层传输；
第七层：物理层。这一层主要就是传输这些二进制数据。
实际应用过程中，五层协议结构里面是没有表示层和会话层的。应该说它们和应用层合并了。我们应该将重点放在应用层和传输层这两个层面。因为HTTP是应用层协议，而TCP是传输层协议。

## 参考资料
1. https://skyao.gitbooks.io/learning-microservice/content/implementation/core/loadbalancer/
2. https://segmentfault.com/a/1190000004492447
3. https://zhuanlan.zhihu.com/p/32854860

----

**茶歇驿站**

一个可以让你停下来看一看，在茶歇之余给你帮助的小站，这里的内容主要是后端技术，个人管理，团队管理，以及其他个人杂想。


![打赏](https://raw.githubusercontent.com/yangwenmai/maiyang.me/master/blog/money.jpg)
